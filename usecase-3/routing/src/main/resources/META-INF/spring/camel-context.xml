<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://camel.apache.org/schema/spring
       http://camel.apache.org/schema/spring/camel-spring.xsd">

    <!-- H2 Datasource -->
    <bean id="usecaseDB"
          class="org.springframework.jdbc.datasource.DriverManagerDataSource">
        <property name="driverClassName" value="org.h2.Driver"/>
        <property name="url" value="jdbc:h2:tcp://localhost/~/usecaseDB"/>
        <property name="username" value="sa"/>
        <property name="password" value=""/>
    </bean>

    <!-- SQL Component -->
    <bean id="sql" class="org.apache.camel.component.sql.SqlComponent">
        <property name="dataSource" ref="usecaseDB" />
    </bean>

    <!-- Spring JMS TxManager -->
    <bean id="jmsTransactionManager"
          class="org.springframework.jms.connection.JmsTransactionManager">
        <property name="connectionFactory" ref="jmsConnectionFactory"/>
    </bean>

    <!-- JMS ConnectionFactory -->
    <bean id="jmsConnectionFactory" class="org.apache.activemq.ActiveMQConnectionFactory">
      <property name="brokerURL" value="tcp://localhost:61616"/>
        <property name="userName" value="admin"/>
        <property name="password" value="admin"/>
        <property name="redeliveryPolicy">
            <bean class="org.apache.activemq.RedeliveryPolicy">
                <property name="maximumRedeliveries" value="0"/>
            </bean>
        </property>
    </bean>
    <!-- ActiveMQ Camel Component - Tx -->
    <bean id="amq-tx" class="org.apache.activemq.camel.component.ActiveMQComponent">
        <property name="transactionManager" ref="jmsTransactionManager"/>
        <property name="connectionFactory" ref="jmsConnectionFactory"/>
        <!-- define the jms consumer/producer as transacted -->
        <property name="transacted" value="true"/>
    </bean>

    <!-- ActiveMQ Camel Component - No Tx -->
    <bean id="amq-notx" class="org.apache.activemq.camel.component.ActiveMQComponent">
        <property name="connectionFactory" ref="jmsConnectionFactory"/>
    </bean>

    <camelContext trace="false"
                  xmlns="http://camel.apache.org/schema/spring">
        <propertyPlaceholder location="fabric8/route.properties"
                             id="properties"/>
        <endpoint
                uri="dozer:csv2json?sourceModel=org.acme.Customer&amp;targetModel=org.globex.Account&amp;unmarshalId=csv&amp;marshalId=transform-json&amp;mappingFile=transformation.xml"
                id="csv2json"/>
        <dataFormats>
            <bindy type="Csv" classType="org.acme.Customer" id="csv"/>
            <json library="Jackson" id="transform-json"/>
        </dataFormats>
        <route>
<!--             <from uri="file:src/data/inbox?autoCreate=false&amp;noop=true" -->
<!--                   id="receiveCustomer"> -->
<!--                 <description/> -->
<!--             </from> -->
			<from uri="amq-tx:queue:customerQ" />
            <log message="${body}" id="log"/>
            <onException>
                <exception>java.lang.IllegalArgumentException</exception>
                <handled>
                    <constant>false</constant>
                </handled>
                <log message="Exception Caught"/>
                <to uri="amq-tx:queue:accountException"/>
            </onException>
            <split>
                <tokenize token="\n"></tokenize>
                <log message="Token :${body}" id="log2"/>
                <to ref="csv2json"/>
                <log message="Marshal: ${body}"/>
                <to uri="amq-tx:queue:accountQ"/>
            </split>
        </route>

        <route id="saveDB">
            <from uri="direct:insertDB"/>
            
            <log message="Bean Type ${body}"/>
<!--             <to uri="sql:{{sql.insertAccount}}"/> -->
<!--             <log message="Inserted new order ${body[id]}"/> -->

        </route>

    </camelContext>
</beans>